<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE Audio Receiver with Opus Codec</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .button {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-family: monospace;
        }
        
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .volume-slider {
            width: 150px;
            height: 5px;
            border-radius: 5px;
            background: rgba(255,255,255,0.3);
            outline: none;
            -webkit-appearance: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4ECDC4;
            cursor: pointer;
        }
        
        .logs {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .visualizer {
            width: 100%;
            height: 100px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .specs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .spec-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .spec-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #4ECDC4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽµ BLE Audio Receiver</h1>
        
        <div class="controls">
            <button id="connectBtn" class="button">Connect to BLE Device</button>
            <button id="startAudioBtn" class="button" disabled>Start Audio Reception</button>
            <button id="stopAudioBtn" class="button" disabled>Stop Audio Reception</button>
        </div>
        
        <div class="status" id="status">
            Status: Ready to connect to BLE device
        </div>
        
        <div class="audio-controls">
            <div class="volume-control">
                <span>ðŸ”Š Volume:</span>
                <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="50">
                <span id="volumeValue">50%</span>
            </div>
        </div>
        
        <canvas id="visualizer" class="visualizer"></canvas>
        
        <div class="specs">
            <div class="spec-item">
                <div>Sample Rate</div>
                <div class="spec-value" id="sampleRate">48000 Hz</div>
            </div>
            <div class="spec-item">
                <div>Channels</div>
                <div class="spec-value" id="channels">Mono</div>
            </div>
            <div class="spec-item">
                <div>Latency</div>
                <div class="spec-value" id="latency">0 ms</div>
            </div>
            <div class="spec-item">
                <div>Packets Received</div>
                <div class="spec-value" id="packetsReceived">0</div>
            </div>
        </div>
        
        <div class="logs" id="logs"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/opusjs/0.1.0/opus.min.js"></script>
    <script>
        class BLEAudioReceiver {
            constructor() {
                this.device = null;
                this.server = null;
                this.service = null;
                this.characteristic = null;
                this.audioContext = null;
                this.opusDecoder = null;
                this.audioBuffer = [];
                this.isReceiving = false;
                this.packetsReceived = 0;
                this.gainNode = null;
                this.analyser = null;
                this.visualizerData = null;
                this.animationId = null;
                
                // Audio specifications - Mono channel
                this.sampleRate = 48000;
                this.channels = 1; // Mono audio
                this.frameSize = 960; // 20ms at 48kHz
                
                this.initializeElements();
                this.setupEventListeners();
            }
            
            initializeElements() {
                this.connectBtn = document.getElementById('connectBtn');
                this.startAudioBtn = document.getElementById('startAudioBtn');
                this.stopAudioBtn = document.getElementById('stopAudioBtn');
                this.status = document.getElementById('status');
                this.logs = document.getElementById('logs');
                this.volumeSlider = document.getElementById('volumeSlider');
                this.volumeValue = document.getElementById('volumeValue');
                this.visualizer = document.getElementById('visualizer');
                this.ctx = this.visualizer.getContext('2d');
                this.packetsCounter = document.getElementById('packetsReceived');
                this.latencyDisplay = document.getElementById('latency');
            }
            
            setupEventListeners() {
                this.connectBtn.addEventListener('click', () => this.connectToBLE());
                this.startAudioBtn.addEventListener('click', () => this.startAudioReception());
                this.stopAudioBtn.addEventListener('click', () => this.stopAudioReception());
                this.volumeSlider.addEventListener('input', (e) => this.updateVolume(e.target.value));
            }
            
            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${message}`;
                console.log(logEntry);
                this.logs.innerHTML += logEntry + '\n';
                this.logs.scrollTop = this.logs.scrollHeight;
            }
            
            updateStatus(message) {
                this.status.textContent = `Status: ${message}`;
                this.log(message);
            }
            
            async connectToBLE() {
                try {
                    this.updateStatus('Requesting BLE device...');
                    
                    // Request any BLE device
                    this.device = await navigator.bluetooth.requestDevice({
                        { namePrefix: 'Audio' }
                    });
                    
                    this.log(`Connected to device: ${this.device.name}`);
                    
                    // Connect to GATT server
                    this.server = await this.device.gatt.connect();
                    this.updateStatus('Connected to GATT server');
                    
                    // Get available services from the connected device
                    const services = await this.server.getPrimaryServices();
                    this.log(`Found ${services.length} services on device`);
                    
                    // Try to find an audio-related service
                    let audioService = null;
                    let audioCharacteristic = null;
                    
                    for (const service of services) {
                        this.log(`Checking service: ${service.uuid}`);
                        try {
                            const characteristics = await service.getCharacteristics();
                            for (const char of characteristics) {
                                this.log(`  - Characteristic: ${char.uuid}, Properties: ${Array.from(char.properties).join(', ')}`);
                                
                                // Look for characteristics that support notifications (likely audio data)
                                if (char.properties.has('notify') || char.properties.has('read')) {
                                    audioService = service;
                                    audioCharacteristic = char;
                                    this.log(`  * Selected as audio characteristic`);
                                    break;
                                }
                            }
                            if (audioCharacteristic) break;
                        } catch (e) {
                            this.log(`  - Could not read characteristics: ${e.message}`);
                        }
                    }
                    
                    if (!audioCharacteristic) {
                        throw new Error('No suitable audio characteristic found');
                    }
                    
                    this.service = audioService;
                    this.characteristic = audioCharacteristic;
                    
                    this.connectBtn.disabled = true;
                    this.startAudioBtn.disabled = false;
                    this.updateStatus('Ready to receive audio');
                    
                } catch (error) {
                    this.log(`Connection error: ${error.message}`);
                    this.updateStatus('Connection failed');
                }
            }
            
            async initializeAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: this.sampleRate
                    });
                    
                    // Create gain node for volume control
                    this.gainNode = this.audioContext.createGain();
                    this.gainNode.gain.value = this.volumeSlider.value / 100;
                    
                    // Create analyser for visualization
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 256;
                    this.visualizerData = new Uint8Array(this.analyser.frequencyBinCount);
                    
                    // Connect audio graph
                    this.gainNode.connect(this.analyser);
                    this.analyser.connect(this.audioContext.destination);
                    
                    this.log('Audio context initialized');
                    return true;
                } catch (error) {
                    this.log(`Audio initialization error: ${error.message}`);
                    return false;
                }
            }
            
            async startAudioReception() {
                try {
                    if (!await this.initializeAudio()) {
                        return;
                    }
                    
                    // Initialize Opus decoder (simulated - real implementation would use actual Opus decoder)
                    this.initializeOpusDecoder();
                    
                    // Start notifications from BLE characteristic
                    await this.characteristic.startNotifications();
                    this.characteristic.addEventListener('characteristicvaluechanged', 
                        (event) => this.handleAudioData(event));
                    
                    this.isReceiving = true;
                    this.startAudioBtn.disabled = true;
                    this.stopAudioBtn.disabled = false;
                    this.updateStatus('Receiving audio data...');
                    
                    // Start visualization
                    this.startVisualization();
                    
                    // Simulate receiving audio data for demo purposes
                    this.simulateAudioData();
                    
                } catch (error) {
                    this.log(`Audio reception error: ${error.message}`);
                }
            }
            
            initializeOpusDecoder() {
                // In a real implementation, you would initialize the Opus decoder here
                // For demo purposes, we'll simulate the decoder
                this.log('Opus decoder initialized (simulated)');
            }
            
            handleAudioData(event) {
                const data = event.target.value;
                const opusData = new Uint8Array(data.buffer);
                
                this.packetsReceived++;
                this.packetsCounter.textContent = this.packetsReceived;
                
                // Decode Opus data (simulated)
                const decodedAudio = this.decodeOpusData(opusData);
                
                if (decodedAudio) {
                    this.playAudioData(decodedAudio);
                }
            }
            
            decodeOpusData(opusData) {
                // Simulated Opus decoding for mono audio
                // In real implementation, use actual Opus decoder
                const frameSize = this.frameSize;
                
                // Generate simulated decoded mono audio (sine wave for demo)
                const decodedSamples = new Float32Array(frameSize);
                const frequency = 440; // A4 note
                
                for (let i = 0; i < frameSize; i++) {
                    decodedSamples[i] = Math.sin(2 * Math.PI * frequency * i / this.sampleRate) * 0.1;
                }
                
                return decodedSamples;
            }
            
            playAudioData(audioData) {
                if (!this.audioContext || !this.isReceiving) return;
                
                const buffer = this.audioContext.createBuffer(
                    this.channels, 
                    this.frameSize, 
                    this.sampleRate
                );
                
                // Fill buffer with decoded mono audio data
                const channelData = buffer.getChannelData(0); // Only one channel for mono
                for (let i = 0; i < this.frameSize; i++) {
                    channelData[i] = audioData[i];
                }
                
                // Create and play audio source
                const source = this.audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(this.gainNode);
                source.start();
            }
            
            simulateAudioData() {
                if (!this.isReceiving) return;
                
                // Simulate receiving BLE audio packets
                setTimeout(() => {
                    if (this.isReceiving && this.characteristic) {
                        // Create simulated Opus packet
                        const simulatedPacket = new ArrayBuffer(64);
                        const event = {
                            target: { value: simulatedPacket }
                        };
                        this.handleAudioData(event);
                        
                        // Continue simulation
                        this.simulateAudioData();
                    }
                }, 20); // 20ms intervals (50 packets per second)
            }
            
            startVisualization() {
                const draw = () => {
                    if (!this.isReceiving || !this.analyser) return;
                    
                    this.animationId = requestAnimationFrame(draw);
                    
                    this.analyser.getByteFrequencyData(this.visualizerData);
                    
                    const canvas = this.visualizer;
                    const ctx = this.ctx;
                    const width = canvas.width = canvas.offsetWidth;
                    const height = canvas.height = canvas.offsetHeight;
                    
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                    ctx.fillRect(0, 0, width, height);
                    
                    const barWidth = width / this.visualizerData.length;
                    
                    for (let i = 0; i < this.visualizerData.length; i++) {
                        const barHeight = (this.visualizerData[i] / 255) * height;
                        const gradient = ctx.createLinearGradient(0, height - barHeight, 0, height);
                        gradient.addColorStop(0, '#4ECDC4');
                        gradient.addColorStop(1, '#FF6B6B');
                        
                        ctx.fillStyle = gradient;
                        ctx.fillRect(i * barWidth, height - barHeight, barWidth - 1, barHeight);
                    }
                };
                
                draw();
            }
            
            stopAudioReception() {
                this.isReceiving = false;
                
                if (this.characteristic) {
                    this.characteristic.stopNotifications();
                }
                
                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                }
                
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
                
                this.startAudioBtn.disabled = false;
                this.stopAudioBtn.disabled = true;
                this.updateStatus('Audio reception stopped');
            }
            
            updateVolume(value) {
                this.volumeValue.textContent = `${value}%`;
                if (this.gainNode) {
                    this.gainNode.gain.value = value / 100;
                }
            }
        }
        
        // Initialize the BLE Audio Receiver when page loads
        document.addEventListener('DOMContentLoaded', () => {
            const receiver = new BLEAudioReceiver();
        });
        
        // Check for Web Bluetooth support
        if (!navigator.bluetooth) {
            document.getElementById('status').textContent = 
                'Status: Web Bluetooth not supported in this browser';
        }
    </script>
</body>
</html>
